var searchEngine = exports;

//interface to mendeley search engine (handles auth + get requests)
var Mendeley = require('mendeleyjs');
//to get google results
var request = require('request');


searchEngine.init = function(){
	
		Mendeley.auth('670', '9N5Q9XupUZEpxuOI', function(msg) {
		
		});
}

searchEngine.normaliseResults = function(searchtype, data){
		//take the raw search data and extract the relevant information before passing
		//it back to the client.
		//each case is unique and has been devised by inspecting the returned data structures
		//changes to the api result formats will cause breaks in code.
		//more elegant solution is wanted
		
		var normalised = new Array();
		
		if (searchtype == 'mendeley') {
			//implemnt parser
			for (var i = 0; i < data.length; i++) {
			
					normalised[i] = new Object();
					
					normalised[i].URL = data[i].link;
					normalised[i].TITLE = data[i].title;
					normalised[i].DESCRIPTION = data[i].abstract;
					normalised[i].DOMAIN = "Mendeley.com";
					normalised[i].IMAGE = "/img/mendeley_default.png";
			}
			
			return normalised;
			
		}
		
		
		
		if (searchtype == 'google') {
		
		
			for (var i = 0; i < data.items.length; i++) {
			
					normalised[i] = new Object();
					
					normalised[i].URL = data.items[i].link;
					normalised[i].TITLE = data.items[i].title;
					normalised[i].DESCRIPTION = data.items[i].snippet;
					normalised[i].DOMAIN = data.items[i].displayLink;
					
					if(data.items[i].pagemap.cse_image != undefined){
						normalised[i].IMAGE = data.items[i].pagemap.cse_image[0].src;
					}else{
						normalised[i].IMAGE = "/img/google_default.png";
					}
					
					console.log(normalised[i]);
			}
			//console.log(normalised);
			return normalised;
			
		}
}

searchEngine.search = function(searchtype, query, next) {
	
		console.log('request :: ' + searchtype + ' : ' + query);

			switch(searchtype){
			
				case 'mendeley':
						Mendeley.search(query, function(data) {
						    next(searchEngine.normaliseResults(searchtype, data));
						});
				break;
				
				case 'google':
						searchEngine.getGoogle(query, function(googleresults){
								//console.log(googleresults)
								next(searchEngine.normaliseResults(searchtype, googleresults));
						});
				break;
				
				}

}

searchEngine.getGoogle = function(querystring, next){
	var urlstr = 'https://www.googleapis.com/customsearch/v1?key=AIzaSyDM8_gZ-5DQVcBUt1y7qq_wAjUDbr4YSTA&cx=009521426283403904660:drg6vvs6o2a&q=' + querystring;
	
	
	request(urlstr, function (error, response, body) {
	  if (!error && response.statusCode == 200) {
	    next(JSON.parse(body));
	  }
	});
	
	
}