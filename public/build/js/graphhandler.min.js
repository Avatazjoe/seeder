/*
 Seeder 2014-09-15 
*/
function ID(){return"_"+Math.random().toString(36).substr(2,9)}function getSaveState(a,b,c,d){var e=JSON.parse($.cookie("seederuserID")),f=new Object;f.datecreated=+new Date,f.likes=0,f.dislikes=0,f.views=0,f.nsize=nodelength,f.esize=edgelength;var g=jQuery.extend(!0,{},a);for(key in g)g[key].nodes.forEach(function(a){delete a.nodedata.imagedata});var h=new Object;return h.graphid=ID(),h.publish=d,h.author=e.id,h.authorname=e.displayName,h.graphname=b,h.graphdesc=c,h.graph=g,h.graphmeta=f,h}var sys,waiting_save_confirm=!1,waiting_publish_confirm=!1,nodelength=0,edgelength=0;$(document).ready(function(){function a(a){s=a.node.data,$("#field_edit_node_name").val(a.node.data.name),$("#field_edit_node_text").val(a.node.data.text),$("#field_edit_node_link").val(a.node.data.link),$("#field_edit_node_size").val(a.node.data.size),$("#picker_edit_edgecolor").val(a.node.data.color)}function b(){for(var a="0123456789ABCDEF".split(""),b="#",c=0;6>c;c++)b+=a[Math.round(15*Math.random())];return b}function c(){$("#btn_publishgraph").hasClass("positive")?($("#btn_publishgraph").removeClass("positive"),$("#btn_savegraph").addClass("positive")):($("#btn_publishgraph").addClass("positive"),$("#btn_savegraph").removeClass("positive"))}function d(a){n.emit("USER_SAVEGRAPH",{payload:a}),a.publish?waiting_publish_confirm=!0:waiting_save_confirm=!0}function e(a){z=a,a+="z",y[a]&&(sys.prune(function(){return!0}),y[a].nodes.forEach(function(a){sys.addNode(a.nodename,a.nodedata)}),y[a].edges.forEach(function(a){sys.addEdge(a.fromnode,a.tonode)}))}function f(a,b){layername=a+"z",y[layername]=new Object,y[layername].layername=a,y[layername].parentlayer=b,y[layername].nodes=new Array,y[layername].edges=new Array}function g(a,b,c){c+="z",y[c].nodes.forEach(function(d,e){return d.nodename==a?(y[c].nodes[e].nodedata=b,!1):void 0})}function h(a,b){sys.pruneNode(a),b+="z";var c=$.grep(y[b].nodes,function(b){return b.nodename!=a});y[b].nodes=c,nodelength-=1;var d=$.grep(y[b].edges,function(b){return b.fromnode!=a&&b.tonode!=a});y[b].edges=d}function i(a,b,c){nodelength+=1,c+="z","LAYER"==b.TYPE&&(f(b.nodeid,z),b.parentlayer=z,y[b.nodeid+"z"].nodes.push({nodename:b.nodeid,nodedata:b})),sys.addNode(b.nodeid,b),y[c].nodes.push({nodename:b.nodeid,nodedata:b})}function j(a,b,c){edgelength+=1,c+="z",sys.addEdge(a,b),y[c].edges.push({fromnode:a,tonode:b})}function k(){if(null!=s||void 0!=s){var a=new Object;return a.name=$("#field_edit_node_name").val(),a.text=$("#field_edit_node_text").val(),a.link=$("#field_edit_node_link").val(),a.size=$("#field_edit_node_size").val(),a.id=b(),a.color=$("#picker_edit_edgecolor").val(),a.TYPE=s.TYPE,""==a.name?($("#field_edit_node_name").addClass("errorform"),-1):($("#field_edit_node_name").removeClass("errorform"),a)}}function l(){var a=new Object;return a.name=$("#field_node_name").val(),a.text=$("#field_node_text").val(),a.link=$("#field_node_link").val(),a.size=$("#field_node_size").val(),a.id=b(),a.color=$("#picker_edgecolor").val(),a.TYPE=$("#select_node_type").val(),""==a.name?($("#field_node_name").addClass("errorform"),-1):($("#field_node_name").removeClass("errorform"),a)}var m="127.0.0.1",n=io.connect(m+":8080"),o=!1,p=!1,q=new Array;$("#tabs").tabs(),$("input[type=submit]").button(),$("#pallete").draggable({containment:"parent"}),$("#graph_tab").height($("body").height()),$("#text_tab").height(0),$("#tabs-1").show(),$("#tabs-2").hide(),$("#tabs-3").hide(),$("#tabs-4").hide(),$("#updatelabel").hide();var r=$(".ui.sidebar");r.sidebar("toggle"),r.sidebar("attach events","#sidebar-toggle","toggle");var s,t=!1,u=$("#menu").width(),v=$("#nav").height(),w=new Object,x=new Object,y=new Object,z="-1";f("-1","0"),w.name="Start",w.text="lorem ipsum",w.link="http://www.google.com/",w.TYPE="TEXT",w.size=30,w.nodeid="-1",w.color="#564F8A",sys=arbor.ParticleSystem(0,500,1),sys.parameters({gravity:!0,friction:1,repulsion:0}),sys.renderer=Renderer("#graph_canvas"),i("-1",w,z);var A,B,C,D=0,E=new Object;E.w=300,E.h=70,E.title="Welcome!",E.subtext="begin by adding some nodes",note("#contain_main",E),$("body").mousemove(function(a){var b={x:a.pageX-270,y:a.pageY-50};if(A=b,B=sys.nearest(b),B&&"ARTICLE"==B.node.data.TYPE&&(B.node.data.NEAREST=!0,$("#node-title").text(B.node.data.TITLE),$("#node-domain").text(B.node.data.DOMAIN),$("#node-description").text(B.node.data.DESCRIPTION),$("#node-image").attr("src",B.node.data.IMAGE),$("#node-link").attr("href",B.node.data.URL)),o){var c=$("#field_node_size").val(),d=$("#picker_edgecolor").val();""==c||""==d?$("#node-dropper").css("top",a.pageY-v+"px").css("left",a.pageX+u+"px"):($("#node-dropper").css("top",a.pageY-v+"px").css("left",a.pageX+u+"px"),$("#node-dropper").css("background-color",d),$("#node-dropper").css("width",2*c+"px"),$("#node-dropper").css("height",2*c+"px"),$("#node-dropper").css("border-radius",c+"px"))}}),$("#graph_canvas").click(function(b){sys.start();var c=sys.nearest({x:b.offsetX,y:b.offsetY});if(o){var d=jQuery.extend(!0,{},w);d.nodeid=++D+"";var e=!1;if(sys.eachNode(function(a){a.data.name==w.name&&(e=!0)}),e)alert('node name already exists, you can edit nodes by clicking "edit nodes"');else if(null!=c){i(d.nodeid,d,z),j(c.node.data.nodeid,d.nodeid,z);var f=new Object;f.w=300,f.h=70,f.title="Node Added!",f.subtext="node named "+d.name+" added.",note("#contain_main",f),D++}else{i(d.nodeid,d,z);var f=new Object;f.w=300,f.h=70,f.title="Node Added!",f.subtext="node named "+d.name+" added.",note("#contain_main",f)}$("#node-dropper").remove(),$("#btn_addnode").removeClass("red").addClass("green"),$("#btn_addnode").val("Add Node"),o=!1;var g=0;return sys.eachNode(function(){g++}),void(g>=1&&sys.parameters({gravity:!0,friction:.1,repulsion:0,stiffness:500}))}return p?((0==q.length||1==q.length)&&(q.push(c),1==q.length&&$("#edgesource").text(q[0].node.data.name)),void(2==q.length&&($("#edgedestination").text(q[1].node.data.name),$("#btn_addedge").removeClass("red").addClass("green"),$("#btn_addedge").val("Add Edge"),j(q[0].node.data.nodeid,q[1].node.data.nodeid,z),p=!1,q=new Array))):$("#tabs-3").is(":visible")?($("#form_editnode").show(),$("#edit_notice").hide(),void a(c)):void 0}),$("#graph_canvas").dblclick(function(a){var b=sys.nearest({x:a.offsetX,y:a.offsetY});b.distance<20&&"LAYER"==b.node.data.TYPE&&e(b.node.data.nodeid==z?y[z+"z"].parentlayer:b.node.data.nodeid)}),$("#editnode_tab_button").click(function(){$("#edit_notice").show()}),$(window).scroll(function(a){o&&a.preventDefault()}),$("body").mousedown(function(a){if(-1!=a.target.className.indexOf("result_adder")||-1!=a.target.parentElement.className.indexOf("result_adder")){t=!0,$("#search_results_holder").css("overflow-x","hidden"),$("search_results_holder").addClass("stop-scroll");var b=new Object;if("sr"==a.target.className){var c=$(a.srcElement).closest(".sr")[0];console.log(c),b.URL=c.attributes.URL.nodeValue,b.DESCRIPTION=c.attributes.DESCRIPTION.nodeValue,b.TITLE=c.attributes.TITLE.nodeValue,b.IMAGE=c.attributes.IMAGE.nodeValue,b.TYPE=c.attributes.TYPE.nodeValue,b.DOMAIN=c.attributes.DOMAIN.nodeValue,b.NEAREST=!1}else{var d=$(a.srcElement.parentElement).closest(".sr")[0];console.log(d),b.URL=d.attributes.URL.nodeValue,b.DESCRIPTION=d.attributes.DESCRIPTION.nodeValue,b.TITLE=d.attributes.TITLE.nodeValue,b.IMAGE=d.attributes.IMAGE.nodeValue,b.TYPE=d.attributes.TYPE.nodeValue,b.DOMAIN=d.attributes.DOMAIN.nodeValue,b.NEAREST=!1}var e=new Object;e.w=300,e.h=70,e.title="Adding Article!",e.subtext="release near destination to add",note("#contain_main",e),C=b}}),$("body").mouseup(function(a){if($("body").removeClass("unselectable"),$("search_results_holder").removeClass("stop-scrolling"),t){$("#search_results_holder").css("overflow-x","scroll");var b=new Image;b.src=C.IMAGE,C.imagedata=b,t=!1;var c=0,d=sys.nearest({x:a.pageX-270,y:a.pageY-50});d?(C.nodeid=D+"",i(D+"",C,z),j(d.node.data.nodeid,D+"",z)):i(D+"",C,z),sys.eachNode(function(){c++});var e=new Object;e.w=300,e.h=70,e.title="Added Article!",e.subtext="Article bound to node "+d.node.data.name,note("#contain_main",e),D++}n.on("hs_id",function(a){n.id=a.data}),n.on("SAVE_SUCCESS",function(){if(waiting_save_confirm){waiting_save_confirm=!1,$("#savepanel").css("height",$("#updatelabel").height()+10+"px");var a=new Date;$("#lastsave").text(" "+a),$("#lastlink").hide(),$("#updatelabel").show()}}),n.on("PUBLISH_SUCCESS",function(a){if(waiting_publish_confirm){waiting_publish_confirm=!1,$("#savepanel").css("height",$("#updatelabel").height()+10+"px"),$("#savepanel").css("background-color","#ffffff");var b=new Date;$("#lastsave").text(" "+b.toDateString()),$("#lastlink").attr("href",a.payload),$("#lastlink").attr("target","_blank"),$("#updatelabel").show()}})}),$("#btn_publishgraph").click(function(){$("#search_results_holder").height(0),$("#savepanel").css("height","150px"),$("#savepanel").css("background-color","#564F8A");var a=$("#sp_graphname").val(),b=$("#sp_graphdesc").val();$("#sp_graphname").val(""),$("#sp_graphdesc").val(""),""!=a&&""!=b&&d(getSaveState(y,a,b,1))}),$("#btn_savegraph").click(function(){$("#search_results_holder").height(0),$("#savepanel").css("height","100px"),$("#savepanel").css("background-color","#564F8A"),c();var a=$("#sp_graphname").val(),b=$("#sp_graphdesc").val();""!=a&&""!=b&&d(getSaveState(y,a,b,0))}),$(".edittab").click(function(a){var b=a.target||a.srcElement;$(".edittab").removeClass("active"),$(b).addClass("active"),$(b).addClass("purple"),$("#tabs-1").hide(),$("#tabs-2").hide(),$("#tabs-3").hide(),$("#tabs-4").hide(),$("#form_editnode").hide(),$(b.getAttribute("tablink")).show()}),$("body").click(function(a){"delete"==a.srcElement.className&&h($(".delete").attr("node-data"),z)}),$("#btn_export").click(function(){var a="";sys.eachNode(function(b){b.data[4]?"article"==b.data[4].val&&(a+=b.data[2].val+" Available From <"+b.data[0].val+">\n\n"):"TEXT"==b.data.TYPE&&(a+=b.data.name+" Available From <"+b.data.link+">\n\n")});var b=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(b,"reference list.txt")}),$("input").on("input",function(a){var b=a.srcElement.className;b.indexOf("add")&&(w=l()),b.indexOf("edit")&&(x=k())}),$("#btn_addedge").click(function(){p?($("#btn_addedge").removeClass("red").addClass("green"),$("#btn_addedge").val("Add Edge"),p=!1):(p=!0,$("#btn_addedge").removeClass("green").addClass("red"),$("#btn_addedge").val("cancel"))}),$("#btn_editnode").click(function(){x.easing="cubic",x.nodeid=s.nodeid,sys.tweenNode(s.nodeid,.5,x),g(s.nodeid,x,z),$("#form_editnode").hide(),$("#edit_notice").show()}),$("#btn_addnode").click(function(){if(o)$("#btn_addnode").removeClass("red").addClass("green"),$("#btn_addnode").val("Add Node"),o=!o,$("#node-dropper").remove();else if(w=l(),-1!=w){o=!0,$("#btn_addnode").removeClass("green").addClass("red"),$("#btn_addnode").val("cancel"),$("body").append('<div id="node-dropper"></div>');var a=new Object;a.w=300,a.h=70,a.title="Adding node!",a.subtext="click to place the node : ",note("#contain_main",a)}else alert("form invalid, please enter a name for the node ")})});