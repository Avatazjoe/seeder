/*
 Seeder 2014-07-27 
*/
function ID(){return"_"+Math.random().toString(36).substr(2,9)}function getSaveState(a,b,c,d){var e=JSON.parse($.cookie("seederuser")),f=new Object;f.datecreated=+new Date,f.likes=0,f.dislikes=0,f.views=0,f.nsize=nodelength,f.esize=edgelength;var g=jQuery.extend(!0,{},a);for(key in g)g[key].nodes.forEach(function(a){delete a.nodedata.imagedata});var h=new Object;return h.graphid=ID(),h.publish=d,h.author=e.id,h.graphname=b,h.graphdesc=c,h.graph=g,h.graphmeta=f,h}var sys,waiting_save_confirm=!1,waiting_publish_confirm=!1,nodelength=0,edgelength=0;$(document).ready(function(){function a(){G.add(K),G.add(H),E.appendChild(F.element),window.addEventListener("resize",b)}function b(){F.setSize(1200,800)}function c(){D=Date.now()-L,void 0!=C?H.setPosition(C.x-590,-C.y+300,10):H.setPosition(300*Math.sin(.001*D),200*Math.cos(5e-4*D),60),F.render(G),requestAnimationFrame(c)}function d(a){u=a.node.data,$("#field_edit_node_name").val(a.node.data.name),$("#field_edit_node_text").val(a.node.data.text),$("#field_edit_node_link").val(a.node.data.link),$("#field_edit_node_size").val(a.node.data.size),$("#picker_edit_edgecolor").val(a.node.data.color)}function e(){for(var a="0123456789ABCDEF".split(""),b="#",c=0;6>c;c++)b+=a[Math.round(15*Math.random())];return b}function f(){$("#btn_publishgraph").hasClass("positive")?($("#btn_publishgraph").removeClass("positive"),$("#btn_savegraph").addClass("positive")):($("#btn_publishgraph").addClass("positive"),$("#btn_savegraph").removeClass("positive"))}function g(a){var b="";for(property in a.graph)b+=property+": "+a.graph[property]+"; ";p.emit("USER_SAVEGRAPH",{payload:a}),a.publish?waiting_publish_confirm=!0:waiting_save_confirm=!0}function h(a){B=a,a+="z",A[a]&&(sys.prune(function(){return!0}),A[a].nodes.forEach(function(a){sys.addNode(a.nodename,a.nodedata)}),A[a].edges.forEach(function(a){sys.addEdge(a.fromnode,a.tonode)}))}function i(a,b){layername=a+"z",A[layername]=new Object,A[layername].layername=a,A[layername].parentlayer=b,A[layername].nodes=new Array,A[layername].edges=new Array}function j(a,b,c){c+="z",A[c].nodes.forEach(function(d,e){return d.nodename==a?(A[c].nodes[e].nodedata=b,!1):void 0})}function k(a,b,c){nodelength+=1,c+="z","LAYER"==b.TYPE&&(i(b.nodeid,B),b.parentlayer=B,A[b.nodeid+"z"].nodes.push({nodename:b.nodeid,nodedata:b})),sys.addNode(b.nodeid,b),A[c].nodes.push({nodename:b.nodeid,nodedata:b})}function l(a,b,c){edgelength+=1,c+="z",sys.addEdge(a,b),A[c].edges.push({fromnode:a,tonode:b})}function m(){if(null!=u||void 0!=u){var a=new Object;return a.name=$("#field_edit_node_name").val(),a.text=$("#field_edit_node_text").val(),a.link=$("#field_edit_node_link").val(),a.size=$("#field_edit_node_size").val(),a.id=e(),a.color=$("#picker_edit_edgecolor").val(),a.TYPE=u.TYPE,""==a.name?($("#field_edit_node_name").addClass("errorform"),-1):($("#field_edit_node_name").removeClass("errorform"),a)}}function n(){var a=new Object;return a.name=$("#field_node_name").val(),a.text=$("#field_node_text").val(),a.link=$("#field_node_link").val(),a.size=$("#field_node_size").val(),a.id=e(),a.color=$("#picker_edgecolor").val(),a.TYPE=$("#select_node_type").val(),""==a.name?($("#field_node_name").addClass("errorform"),-1):($("#field_node_name").removeClass("errorform"),a)}var o="127.0.0.1",p=io.connect(o+":8080"),q=!1,r=!1,s=new Array;$("#tabs").tabs(),$("input[type=submit]").button(),$("#pallete").draggable({containment:"parent"}),$("#graph_tab").height($("body").height()),$("#text_tab").height(0),$("#tabs-1").show(),$("#tabs-2").hide(),$("#tabs-3").hide(),$("#tabs-4").hide(),$("#updatelabel").hide();var t=$(".ui.sidebar");t.sidebar("toggle"),t.sidebar("attach events","#sidebar-toggle","toggle");var u,v=!1,w=$("#menu").width(),x=$("#nav").height(),y=new Object,z=new Object,A=new Object,B="-1";i("-1","0"),y.name="Start",y.text="lorem ipsum",y.link="http://www.google.com/",y.TYPE="TEXT",y.size=30,y.nodeid=-1,y.color="#564F8A",sys=arbor.ParticleSystem(0,500,1),sys.parameters({gravity:!0,friction:1,repulsion:0}),sys.renderer=Renderer("#graph_canvas"),k("-1",y,B);var C,D,E=document.getElementById("BGlayer"),F=new FSS.CanvasRenderer,G=new FSS.Scene,H=new FSS.Light("#555555","#2D2D2D"),I=new FSS.Plane(1200,800,12,12),J=new FSS.Material("#C066FF","#FFFFFF"),K=new FSS.Mesh(I,J),L=Date.now();a(),b(),c();var M,N,O=0,P=new Object;P.w=300,P.h=70,P.title="Welcome!",P.subtext="begin by adding some nodes",note("#contain_main",P),$("body").mousemove(function(a){var b={x:a.pageX-270,y:a.pageY-50};if(C=b,M=sys.nearest(b),M&&"ARTICLE"==M.node.data.TYPE&&(M.node.data.NEAREST=!0,$("#node-title").text(M.node.data.TITLE),$("#node-domain").text(M.node.data.DOMAIN),$("#node-description").text(M.node.data.DESCRIPTION),$("#node-image").attr("src",M.node.data.IMAGE),$("#node-link").attr("href",M.node.data.URL)),q){var c=$("#field_node_size").val(),d=$("#picker_edgecolor").val();""==c||""==d?$("#node-dropper").css("top",a.pageY-x+"px").css("left",a.pageX+w+"px"):($("#node-dropper").css("top",a.pageY-x+"px").css("left",a.pageX+w+"px"),$("#node-dropper").css("background-color",d),$("#node-dropper").css("width",2*c+"px"),$("#node-dropper").css("height",2*c+"px"),$("#node-dropper").css("border-radius",c+"px"))}}),$("#graph_canvas").click(function(a){sys.start();var b=sys.nearest({x:a.offsetX,y:a.offsetY});if(q){var c=jQuery.extend(!0,{},y);c.nodeid=++O+"";var e=!1;if(sys.eachNode(function(a){a.data.name==y.name&&(e=!0)}),e)alert('node name already exists, you can edit nodes by clicking "edit nodes"');else if(null!=b){k(c.nodeid,c,B),l(b.node.data.nodeid,c.nodeid,B);var f=new Object;f.w=300,f.h=70,f.title="Node Added!",f.subtext="node named "+c.name+" added.",note("#contain_main",f),O++}else{k(c.nodeid,c,B);var f=new Object;f.w=300,f.h=70,f.title="Node Added!",f.subtext="node named "+c.name+" added.",note("#contain_main",f)}$("#node-dropper").remove(),$("#btn_addnode").removeClass("red").addClass("green"),$("#btn_addnode").val("Add Node"),q=!1;var g=0;return sys.eachNode(function(){g++}),void(g>=1&&sys.parameters({gravity:!0,friction:.1,repulsion:0,stiffness:500}))}return r?((0==s.length||1==s.length)&&(s.push(b),1==s.length&&$("#edgesource").text(s[0].node.data.name)),void(2==s.length&&($("#edgedestination").text(s[1].node.data.name),$("#btn_addedge").removeClass("red").addClass("green"),$("#btn_addedge").val("Add Edge"),l(s[0].node.data.nodeid,s[1].node.data.nodeid,B),r=!1,s=new Array))):$("#tabs-3").is(":visible")?($("#form_editnode").show(),$("#edit_notice").hide(),void d(b)):void 0}),$("#graph_canvas").dblclick(function(a){var b=sys.nearest({x:a.offsetX,y:a.offsetY});b.distance<20&&"LAYER"==b.node.data.TYPE&&h(b.node.data.nodeid==B?A[B+"z"].parentlayer:b.node.data.nodeid)}),$("#editnode_tab_button").click(function(){$("#edit_notice").show()}),$(window).scroll(function(a){q&&a.preventDefault()}),$("body").mousedown(function(a){if(-1!=a.target.className.indexOf("search_result")||-1!=a.target.parentElement.className.indexOf("search_result")){v=!0,$("#search_results_holder").css("overflow-x","hidden"),$("search_results_holder").addClass("stop-scroll");var b=new Object;"search_result"==a.target.className?(b.URL=a.srcElement.attributes.URL.nodeValue,b.DESCRIPTION=a.srcElement.attributes.DESCRIPTION.nodeValue,b.TITLE=a.srcElement.attributes.TITLE.nodeValue,b.IMAGE=a.srcElement.attributes.IMAGE.nodeValue,b.TYPE=a.srcElement.attributes.TYPE.nodeValue,b.DOMAIN=a.srcElement.attributes.DOMAIN.nodeValue,b.NEAREST=!1):(b.URL=a.srcElement.parentElement.attributes.URL.nodeValue,b.DESCRIPTION=a.srcElement.parentElement.attributes.DESCRIPTION.nodeValue,b.TITLE=a.srcElement.parentElement.attributes.TITLE.nodeValue,b.IMAGE=a.srcElement.parentElement.attributes.IMAGE.nodeValue,b.TYPE=a.srcElement.parentElement.attributes.TYPE.nodeValue,b.DOMAIN=a.srcElement.parentElement.attributes.DOMAIN.nodeValue,b.NEAREST=!1);var c=new Object;c.w=300,c.h=70,c.title="Adding Article!",c.subtext="release near destination to add",note("#contain_main",c),N=b}}),$("body").mouseup(function(a){if($("body").removeClass("unselectable"),$("search_results_holder").removeClass("stop-scrolling"),v){$("#search_results_holder").css("overflow-x","scroll");var b=new Image;b.src=N.IMAGE,N.imagedata=b,v=!1;var c=0,d=sys.nearest({x:a.pageX-270,y:a.pageY-50});d?(N.nodeid=O+"",k(O+"",N,B),l(d.node.data.nodeid,O+"",B)):k(O+"",N,B),sys.eachNode(function(){c++});var e=new Object;e.w=300,e.h=70,e.title="Added Article!",e.subtext="Article bound to node "+d.node.data.name,note("#contain_main",e),O++}p.on("hs_id",function(a){p.id=a.data}),p.on("request_pullGraph_success",function(a){rebuildPullGraph(a.data)}),p.on("SAVE_SUCCESS",function(){if(waiting_save_confirm){waiting_save_confirm=!1,$("#savepanel").css("height",$("#updatelabel").height()+10+"px");var a=new Date;$("#lastsave").text(" "+a),$("#lastlink").hide(),$("#updatelabel").show()}}),p.on("PUBLISH_SUCCESS",function(a){if(waiting_publish_confirm){waiting_publish_confirm=!1,$("#savepanel").css("height",$("#updatelabel").height()+10+"px"),$("#savepanel").css("background-color","#ffffff");var b=new Date;$("#lastsave").text(" "+b.toDateString()),$("#lastlink").attr("href",a.payload),$("#lastlink").attr("target","_blank"),$("#updatelabel").show()}})}),$("#btn_publishgraph").click(function(){$("#search_results_holder").height(0),$("#savepanel").css("height","150px"),$("#savepanel").css("background-color","#564F8A");var a=$("#sp_graphname").val(),b=$("#sp_graphdesc").val();$("#sp_graphname").val(""),$("#sp_graphdesc").val(""),""!=a&&""!=b&&g(getSaveState(A,a,b,1))}),$("#btn_savegraph").click(function(){$("#search_results_holder").height(0),$("#savepanel").css("height","100px"),$("#savepanel").css("background-color","#564F8A"),f();var a=$("#sp_graphname").val(),b=$("#sp_graphdesc").val();""!=a&&""!=b&&g(getSaveState(A,a,b,0))}),$(".edittab").click(function(a){var b=a.target||a.srcElement;$(".edittab").removeClass("active"),$(b).addClass("active"),$(b).addClass("purple"),$("#tabs-1").hide(),$("#tabs-2").hide(),$("#tabs-3").hide(),$("#tabs-4").hide(),$("#form_editnode").hide(),$(b.getAttribute("tablink")).show()}),$("#btn_export").click(function(){var a="";sys.eachNode(function(b){b.data[4]?"article"==b.data[4].val&&(a+=b.data[2].val+" Available From <"+b.data[0].val+">\n\n"):"TEXT"==b.data.TYPE&&(a+=b.data.name+" Available From <"+b.data.link+">\n\n")});var b=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(b,"reference list.txt")}),$("input").on("input",function(a){var b=a.srcElement.className;b.indexOf("add")&&(y=n()),b.indexOf("edit")&&(z=m())}),$("#btn_addedge").click(function(){r?($("#btn_addedge").removeClass("red").addClass("green"),$("#btn_addedge").val("Add Edge"),r=!1):(r=!0,$("#btn_addedge").removeClass("green").addClass("red"),$("#btn_addedge").val("cancel"))}),$("#btn_editnode").click(function(){z.easing="cubic",z.nodeid=u.nodeid,sys.tweenNode(u.nodeid,.5,z),j(u.nodeid,z,B),$("#form_editnode").hide(),$("#edit_notice").show()}),$("#btn_addnode").click(function(){if(q)$("#btn_addnode").removeClass("red").addClass("green"),$("#btn_addnode").val("Add Node"),q=!q,$("#node-dropper").remove();else if(y=n(),-1!=y){q=!0,$("#btn_addnode").removeClass("green").addClass("red"),$("#btn_addnode").val("cancel"),$("body").append('<div id="node-dropper"></div>');var a=new Object;a.w=300,a.h=70,a.title="Adding node!",a.subtext="click to place the node : ",note("#contain_main",a)}else alert("form invalid, please enter a name for the node ")})});